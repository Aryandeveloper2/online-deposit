{% extends  "extension/component/layouts/form_layout.twig" %}

{% block content %}
        <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-module" class="form-horizontal">
            {{ save_section.input }}
            
             <ul class="nav nav-tabs" id="dtabs">
                <li class="active"><a href="#general"  data-toggle="tab">
                عمومی
                </a></li>
                <li><a href="#glink"  data-toggle="tab">
                ساخت لینک پرداخت
                </a></li>
                <li><a href="#transactions" data-toggle="tab">
                    
                    تراکنش‌ها
                </a></li>
            </ul>
            
            
            
            <div class="tab-content">
                <div class="tab-pane active" id="general">
                    {{ main_sub_module_form }}
                    
                  
                    
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-custom_price">
                        پرداخت دلخواه
                        </label>
                        <div class="col-sm-10">
                            <select name="custom_price" id="input-custom_price" class="form-control">
                                <option value="0" {{ custom_price == 0 ? 'selected="selected"' : "" }}>{{ text_disabled }}</option>
                                <option value="1" {{ custom_price == 1 ? 'selected="selected"' : "" }}>{{ text_enabled }}</option>
                            </select>
                        </div>
                      </div>
                      
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-custom_price">
                        روش‌های پرداخت
                        </label>
                        <div class="col-sm-10">
                            {% for method in payment_methods %}
                                <label class="m-4">
                                    {{method.title}}
                                    <input type="checkbox" name="selected_payment_methods[]" value="{{ method.code }}" {{method.selected ? ' checked ' : ''}} />
                                </label>
                            
                            {% endfor %}
                        </div>
                      </div>
                      
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-tax-class">کلاس‌ مالیاتی</label>
                        <div class="col-sm-10">
                          <select name="tax_class_id" id="input-tax-class" class="form-control">
                            <option value="0">{{ text_none }}</option>
                            
        
                            {% for tax_class in tax_classes %}
                            {% if tax_class.tax_class_id == tax_class_id %}
        
                            
                            <option value="{{ tax_class.tax_class_id }}" selected="selected">{{ tax_class.title }}</option>
                            
        
                            {% else %}
        
                            
                            <option value="{{ tax_class.tax_class_id }}">{{ tax_class.title }}</option>
                            
        
                            {% endif %}
                            {% endfor %}
        
                          
                          </select>
                        </div>
                      </div>
                      
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-price_list">
                            قیمت های ثابت
                        </label>
                        <div class="col-sm-10">
                           
                            <table id="price_list" class="table table-striped table-bordered table-hover drag_and_drop_sort">
                                <thead><tr>
                                    <td class="text-right">قیمت</td> 
                                    <td class="text-right">ترتیب</td> 
                                    <td class="text-right">عملیات</td>
                                </tr></thead>
                                <tbody class="price_lists">        
                                {% set price_row = 0 %}
                                    {% for item in price_list %}
                                        <tr id="price_row{{ price_row }}">
                                          
                                            <td class="text-right">
                                                <input type="number" name="price_list[{{price_row}}][price]" value="{{ item.price }}"
                                                placeholder="{{ entry_price }}" class="form-control" />
                                                {% if error_price %}
                                                    <p class="text-danger">{{ error_price[price_row] }}</p>
                                                {% endif %}
                                            </td>
                                        
                                      
                                            <td class="text-right">
                                                <input type="text" name="price_list[{{price_row}}][sort_order]" value="{{ item.sort_order }}"
                                                placeholder="{{ entry_sort }}" class="form-control w-50" />
                                            </td>
                                            <td class="text-right">
                                                <button type="button" onclick="$('#price_row{{ price_row }}').remove();" data-toggle="tooltip" 
                                                title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>
                                        </tr>
                                    {% set price_row = price_row + 1 %}
                                {% endfor %}
                                </tbody>   
                                <tfoot>
                                <tr>
                                    <td colspan="2"></td>
                                    <td class="text-right"><button type="button" onclick="addPrice();" data-toggle="tooltip" title="{{ button_item_add }}" class="btn btn-primary"><i class="fa fa-plus-circle"></i></button></td>
                                </tr>
                                </tfoot>
                            </table>
                            
                            
                            
                            <script>
                                
                                
                                var price_row = {{ price_row }};
                                function addPrice() {
                                    html = `
                                         <tr id="price_row${ price_row }">
                                          
                                            <td class="text-right">
                                                <input type="number" name="price_list[${price_row}][price]"
                                                placeholder="{{ entry_price }}" class="form-control" />
                                             
                                            </td>
                                        
                                      
                                            <td class="text-right">
                                                <input type="text" name="price_list[${price_row}][sort_order]"
                                                placeholder="{{ entry_sort }}" class="form-control w-50" />
                                            </td>
                                            <td class="text-right">
                                                <button type="button" onclick="$('#price_row${ price_row }').remove();" data-toggle="tooltip" 
                                                title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>
                                        </tr>
                                    
                                     `;
                                    
                                	$(`#price_list tbody`).append(html);
                                	price_row++;
                                }

                            </script>
                           
                           
                        </div>
                      </div>
                </div>
                
                <div class="tab-pane" id="glink">
                      <div class="form-group">
                        <label class="col-sm-2 control-label" for="generate_link">
                            قیمت
                        </label>
                        <div class="col-sm-10 d-flex">
                            <input type="number" id="generate_link" class="form-control ml-3" placeholder="قیمت">
                            <button type="button" class="btn btn-primary" onClick="generateLink()">ساخت لینک</button>
                        </div>
                        
                        <script>
                            function generateLink() {
                                let price = $('#generate_link').val()
                                
                                 $.ajax({
                                      url: 'index.php?route=extension/module/online_deposit/generateLink',
                                      type: 'get',
                                      dataType: 'json',
                                      data:'user_token={{ user_token }}&price='+ price,
                                      beforeSend: function() {},
                                      success: function(response) {
                                             navigator.clipboard.writeText(response.sig)
                                            .then(() => {
                                                alert("متن کپی شد ✅");
                                            })
                                            .catch(err => {
                                                alert("خطا در کپی!");
                                                console.error(err);
                                            });
                                      },
                                      error: function() {}
                                  });
                          
                            }
                        </script>
                      </div>
                </div>
                
                <div class="tab-pane" id="transactions">
                    
                    <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                        <tr>
                            <td class="text-left">مشتری</td>
                            <td class="text-right">مبلغ</td>
                            <td class="text-right">درگاه پرداخت</td>
                            <td class="text-right">وضعیت</td>
                            <td class="text-right">زمان</td>
                        </tr>
                        </thead>
                        <tbody>
                        {% if online_deposits %}
                            {% for online_deposit in online_deposits %}
                                <tr class="{{online_deposit.signature != '' ? 'bg-info' : ''}}">
                                    <td class="text-center">
                                            <a href="{{ online_deposit.customer}}" target="_blank">
                                                {{online_deposit.fullname != '' ? online_deposit.fullname : online_deposit.customer_id }}
                                            </a>
                                    </td>
                                    <td class="text-left">{{ online_deposit.price }}</td>
                                    <td class="text-right">{{ online_deposit.payment_method }}</td>
                                    <td class="text-right">{{ online_deposit.status == 2 ? 'پرداخت موفق': 'پرداخت ناموفق' }}</td>
                                    <td class="text-right">{{ online_deposit.date_added }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td class="text-center" colspan="5">{{ text_no_results }}</td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
                    
                                                           
                                        

        </form>
       
{% endblock %}
